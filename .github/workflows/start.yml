name: start subfoldersync-vibe

on:
  workflow_call:
    inputs:
        source_repo:
            description: 'The repository to sync from, e.g., IMOitself/A'
            required: true
            type: string
        source_branch:
            description: 'The branch to sync from'
            required: true
            type: string
        destination_repo:
            description: 'The repository to sync to, e.g., IMOitself/B'
            required: true
            type: string
        destination_branch:
            description: 'The branch to sync to'
            required: true
            type: string
        subfolder_path:
            description: 'The path to the subfolder to sync'
            required: true
            type: string
        username:
            description: 'The GitHub username to use for commits'
            required: true
            type: string
    secrets:
        gh_pat:
            description: 'A GitHub PAT with repo write access'
            required: true

jobs:
    sync:
        runs-on: ubuntu-latest
        steps:
            - name: Clone subfoldersync-vibe repo
              uses: actions/checkout@v4
              with:
                repository: 'IMOitself/subfoldersync-vibe'
                path: subfoldersync-vibe
                token: ${{ secrets.gh_pat }}

            - name: Checkout Destination Repo
              uses: actions/checkout@v4
              with:
                repository: ${{ inputs.destination_repo }}
                path: dest_repo
                token: ${{ secrets.gh_pat }}
                ref: ${{ inputs.destination_branch }}

            - name: Run sync script
              working-directory: dest_repo
              env:
                SOURCE_REPO: ${{ inputs.source_repo }}
                SOURCE_BRANCH: ${{ inputs.source_branch }}
                SUBFOLDER_PATH: ${{ inputs.subfolder_path }}
              run: |
                chmod +x ../subfoldersync-vibe/sync-subfolders.sh
                ../subfoldersync-vibe/sync-subfolders.sh

            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                repository: dest_repo
                commit_message: "chore: sync subfolder from ${{ inputs.source_repo }}"
                commit_user_name: ${{ inputs.username }}
                commit_user_email: ${{ inputs.username }}@users.noreply.github.com
                branch: ${{ inputs.destination_branch }}